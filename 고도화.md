# Google OAuth redirect_uri_mismatch 해결 가이드

## 문제 원인
`redirect_uri_mismatch` 오류는 Google Cloud Console에 등록된 리디렉션 URI와 실제 요청하는 URI가 일치하지 않을 때 발생합니다.

---

## 1. Google Cloud Console 설정 확인 (필수)

1. [Google Cloud Console](https://console.cloud.google.com/) 접속
2. **API 및 서비스** → **사용자 인증 정보** 이동
3. OAuth 2.0 클라이언트 ID 클릭
4. **승인된 리디렉션 URI**에 아래 URI 등록 확인:
   - `https://travel1.moonwave.kr/api/drive/callback` (Production)
   - `http://localhost:3000/api/drive/callback` (Development)

---

## 2. 현재 Vercel 환경변수 확인

```bash
# 환경변수 목록 확인
vercel env ls

# 로컬에 환경변수 가져오기
vercel env pull .env.local

# Google 관련 변수만 확인
cat .env.local | grep GOOGLE
```

---

## 3. 기존 환경변수 삭제 (잘못된 값이 있을 경우)

```bash
vercel env rm GOOGLE_REDIRECT_URI production
vercel env rm GOOGLE_REDIRECT_URI preview
vercel env rm GOOGLE_REDIRECT_URI development
```

---

## 4. 환경변수 새로 등록

### Production & Preview

```bash
echo "https://travel1.moonwave.kr/api/drive/callback" | vercel env add GOOGLE_REDIRECT_URI production
echo "https://travel1.moonwave.kr/api/drive/callback" | vercel env add GOOGLE_REDIRECT_URI preview
```

### Development (로컬)

```bash
echo "http://localhost:3000/api/drive/callback" | vercel env add GOOGLE_REDIRECT_URI development
```

---

## 5. Client ID / Secret 등록 (필요시)

```bash
# 대화형 입력 - 값을 직접 입력
vercel env add GOOGLE_CLIENT_ID production
vercel env add GOOGLE_CLIENT_SECRET production
```

---

## 6. 재배포

```bash
vercel --prod --force
```

---

## 7. 설정 검증

### 디버그 API 호출

```bash
curl https://travel1.moonwave.kr/api/debug-env
```

### 디버그 API 엔드포인트 코드 (api/debug-env.ts)

```typescript
import type { VercelRequest, VercelResponse } from '@vercel/node'

export default function handler(req: VercelRequest, res: VercelResponse) {
  res.json({
    GOOGLE_REDIRECT_URI: process.env.GOOGLE_REDIRECT_URI || '(not set - using default)',
    GOOGLE_CLIENT_ID: process.env.GOOGLE_CLIENT_ID ? '✓ Set' : '✗ Missing',
    GOOGLE_CLIENT_SECRET: process.env.GOOGLE_CLIENT_SECRET ? '✓ Set' : '✗ Missing',
    defaultURI: 'https://travel1.moonwave.kr/api/drive/callback'
  })
}
```

> ⚠️ **주의**: 디버그 API는 배포 후 환경변수 확인이 끝나면 삭제하거나 접근 제한을 추가하세요.

---

## 체크리스트

- [ ] Google Cloud Console에 리디렉션 URI 등록 완료
- [ ] Vercel 환경변수 설정 완료
- [ ] 재배포 완료
- [ ] 디버그 API로 설정 확인 완료
- [ ] OAuth 로그인 테스트 성공
